{"version":3,"file":"app.js","sources":["App.vue","main.js"],"sourcesContent":["<template>\n  <view class=\"app\">\n    <!-- 应用主容器 -->\n  </view>\n</template>\n\n<script setup>\nimport { ref } from 'vue'\nimport { onLaunch, onShow, onHide } from '@dcloudio/uni-app'\n\n// 登录弹窗显示状态\nlet loginModalShowing = false\n\n// 应用启动\nonLaunch(() => {\n  console.log('App Launch')\n  // 检查登录状态\n  checkLoginStatus()\n})\n\n// 应用显示（从后台进入前台）\nonShow(() => {\n  console.log('App Show')\n  // 每次显示时都检查登录状态\n  checkLoginStatus()\n})\n\n// 应用隐藏\nonHide(() => {\n  console.log('App Hide')\n})\n\n/**\n * 检查登录状态\n */\nfunction checkLoginStatus() {\n  const token = uni.getStorageSync('token')\n  const userInfo = uni.getStorageSync('userInfo')\n  \n  // 如果没有token或用户信息，显示登录弹窗\n  if (!token || !userInfo) {\n    console.log('用户未登录，显示授权弹窗')\n    // 显示登录弹窗\n    if (!loginModalShowing) {\n      loginModalShowing = true\n      showLoginModal()\n    }\n  } else {\n    console.log('用户已登录')\n  }\n}\n\n/**\n * 处理用户授权登录\n */\nfunction handleLogin() {\n  // 调用微信登录\n  uni.login({\n    provider: 'weixin',\n    success: (loginRes) => {\n      console.log('登录成功，code:', loginRes.code)\n      \n      // 在微信小程序中，getUserProfile必须在用户点击事件中调用\n      // 所以我们直接调用获取用户信息的函数\n      // #ifdef MP-WEIXIN\n      getUserInfoAndLogin(loginRes.code)\n      // #endif\n      \n      // #ifndef MP-WEIXIN\n      // 非微信小程序环境的处理\n      const mockToken = 'mock_token_' + Date.now()\n      const userInfo = {\n        avatar: 'http://p3.diaoyur.cn/group3/M00/0B/4C/cjd0iVhwYF-xmeuqfNBk9gLpv4atJ.jpeg',\n        nickname: '游客用户',\n        phone: ''\n      }\n      \n      uni.setStorageSync('token', mockToken)\n      uni.setStorageSync('userInfo', userInfo)\n      \n      loginModalShowing = false\n      \n      uni.showToast({\n        title: '登录成功',\n        icon: 'success'\n      })\n      \n      setTimeout(() => {\n        uni.switchTab({\n          url: '/pages/my/my'\n        })\n      }, 1500)\n      // #endif\n    },\n    fail: (err) => {\n      console.error('登录失败:', err)\n      uni.showToast({\n        title: '登录失败',\n        icon: 'none'\n      })\n      // 登录失败，退出小程序\n      setTimeout(() => {\n        uni.exitMiniProgram()\n      }, 1500)\n    }\n  })\n}\n\n/**\n * 获取用户信息并登录\n * 在用户主动点击事件中调用\n */\nfunction getUserInfoAndLogin(code) {\n  // #ifdef MP-WEIXIN\n  uni.getUserProfile({\n    desc: '用于完善用户资料',\n    success: (userRes) => {\n      console.log('获取用户信息成功:', userRes.userInfo)\n      \n      // 这里应该将code和用户信息发送到后端服务器\n      // 后端验证后返回token\n      // 这里使用模拟数据\n      const mockToken = 'mock_token_' + Date.now()\n      const userInfo = {\n        avatar: userRes.userInfo.avatarUrl,\n        nickname: userRes.userInfo.nickName,\n        phone: '' // 手机号需要单独授权获取\n      }\n      \n      // 存储token和用户信息\n      uni.setStorageSync('token', mockToken)\n      uni.setStorageSync('userInfo', userInfo)\n      \n      // 关闭弹窗\n      loginModalShowing = false\n      \n      // 显示登录成功提示\n      uni.showToast({\n        title: '登录成功',\n        icon: 'success',\n        duration: 1500\n      })\n      \n      // 跳转到\"我的\"页面\n      setTimeout(() => {\n        uni.switchTab({\n          url: '/pages/my/my'\n        })\n      }, 1500)\n    },\n    fail: (err) => {\n      console.error('获取用户信息失败:', err)\n      uni.showToast({\n        title: '获取用户信息失败',\n        icon: 'none'\n      })\n      // 用户拒绝授权，退出小程序\n      setTimeout(() => {\n        uni.exitMiniProgram()\n      }, 1500)\n    }\n  })\n  // #endif\n}\n\n/**\n * 处理取消登录\n */\n/**\n * 显示登录弹窗\n */\nfunction showLoginModal() {\n  uni.showModal({\n    title: '登录提示',\n    content: '为了给您提供更好的服务，需要获取您的微信授权信息。',\n    confirmText: '授权登录',\n    cancelText: '取消',\n    success: (res) => {\n      if (res.confirm) {\n        handleLogin()\n      } else {\n        handleCancelLogin()\n      }\n    },\n    fail: () => {\n      loginModalShowing = false\n    }\n  })\n}\n\n/**\n * 处理取消登录\n */\nfunction handleCancelLogin() {\n  uni.showModal({\n    title: '提示',\n    content: '未登录将无法使用完整功能，确定要退出吗？',\n    success: (res) => {\n      if (res.confirm) {\n        // 关闭弹窗\n        loginModalShowing = false\n        // 退出小程序\n        uni.exitMiniProgram()\n      }\n    }\n  })\n}\n</script>\n\n<style>\n/* 全局样式 */\n@import './static/styles/common.css';\n\n/* 重置默认样式 */\npage {\n  background-color: #f5f5f5;\n  font-size: 28rpx;\n  color: #333;\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',\n    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;\n}\n\n/* 清除按钮默认样式 */\nbutton::after {\n  border: none;\n}\n\n/* 图片默认样式 */\nimage {\n  display: block;\n}\n\n</style>\n","import App from './App.vue'\n\n// #ifndef VUE3\nimport Vue from 'vue'\nimport './uni.promisify.adaptor'\nVue.config.productionTip = false\nApp.mpType = 'app'\nconst app = new Vue({\n  ...App\n})\napp.$mount()\n// #endif\n\n// #ifdef VUE3\nimport { createSSRApp } from 'vue'\nexport function createApp() {\n  const app = createSSRApp(App)\n  return {\n    app\n  }\n}\n// #endif\n"],"names":["onLaunch","uni","onShow","onHide","createSSRApp","App"],"mappings":"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"}